{"version":3,"sources":["worker.node/worker.js"],"names":[],"mappings":"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","file":"worker.node/worker.js","sourcesContent":["import child        from 'child_process';\nimport path         from 'path';\nimport EventEmitter from 'eventemitter3';\n\nimport { getConfig } from '../config';\n\n\nexport default class Worker extends EventEmitter {\n  constructor(initialRunnable, options = {}) {\n    super();\n\n    this.slave = child.fork(path.join(__dirname, 'slave.js'), [], options);\n    this.slave.on('message', this.handleMessage.bind(this));\n    this.slave.on('error', this.handleError.bind(this));\n    this.slave.on('exit', this.emit.bind(this, 'exit'));\n\n    if (initialRunnable) {\n      this.run(initialRunnable);\n    }\n  }\n\n  run(toRun) {\n    if (typeof toRun === 'function') {\n      this.runMethod(toRun);\n    } else {\n      this.runScript(toRun);\n    }\n    return this;\n  }\n\n  runMethod(method) {\n    this.slave.send({\n      initByMethod : true,\n      method       : method.toString()\n    });\n  }\n\n  runScript(script) {\n    if (!script) { throw new Error('Must pass a function or a script path to run().'); }\n\n    const prefixedScriptPath = path.join(getConfig().basepath.node, script);\n\n    // attention: single script for node, array for browser\n    this.slave.send({\n      initByScript : true,\n      script       : path.resolve(prefixedScriptPath)\n    });\n  }\n\n  send(param) {\n    this.slave.send({\n      doRun : true,\n      param\n    });\n    return this;\n  }\n\n  kill() {\n    this.slave.kill();\n    return this;\n  }\n\n  promise() {\n    return new Promise((resolve, reject) => {\n      this\n        .once('message', resolve)\n        .once('error', reject);\n    });\n  }\n\n  handleMessage(message) {\n    if (message.error) {\n      const error = new Error(message.error.message);\n      error.stack = message.error.stack;\n\n      this.handleError(error);\n    } else if (message.progress) {\n      this.handleProgress(message.progress);\n    } else {\n      this.emit('message', ...message.response);\n      this.emit('done', ...message.response);    // this one is just for convenience\n    }\n  }\n\n  handleProgress(progress) {\n    this.emit('progress', progress);\n  }\n\n  handleError(error) {\n    if (!this.listeners('error', true)) {\n      console.error(error.stack || error);       // eslint-disable-line no-console\n    }\n    this.emit('error', error);\n  }\n}\n"],"sourceRoot":"/source/"}