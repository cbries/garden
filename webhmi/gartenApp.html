<!DOCTYPE html>
<html>
<head>
 <title>GartenApp</title>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <script type="text/javascript" src="jquery.min.js"></script>
 <script type="text/javascript">
 
var cfg = { wsaddr: "ws://localhost:23234" };
//var cfg = { wsaddr: "ws://192.168.178.33:23234" };

var valveMap = [
	{ name: "main", state: false, lastAccess: 0 },
	{ name: "trees", state: false, lastAccess: 0 },
	{ name: "reserved", state: false, lastAccess: 0 }
];

var weatherData = {
	"temperature" : null,
	"humidity" : null
};

// ################################################################

var btnValveMain = null;
var btnValveTrees = null;
var btnValveReserved = null;

var imgHumanity = null;
var dataHumanity = null;

var imgWeather = null;
var dataWeather = null;

var imgPressure = null
var dataPressure = null;

function initStates() {
	btnValveMain = $('#btnValveMain');
	btnValveTrees = $('#btnValveTrees');
	btnValveReserved = $('#btnValveReserved');

	imgHumanity = $('#imghumanity');
	dataHumanity = $('#datathumanity');
	
	imgWeather = $('#imgtemperature');
	dataWeather = $('#datatemperature');

	imgPressure = $('#imgpressure');
	dataPressure = $('#datapressure');

	if(btnValveMain !== null && btnValveMain !== 'undefined')
		btnValveMain.addClass('toggle-button-disabled');
	if(btnValveTrees !== null && btnValveTrees !== 'undefined')
		btnValveTrees.addClass('toggle-button-disabled');
	if(btnValveReserved !== null && btnValveReserved !== 'undefined')
		btnValveReserved.addClass('toggle-button-disabled');

	for(var i=0; i < valveMap.length; ++i) {
		valveMap[i].state = false;
		valveMap[i].lastAccess = 0;
	}
}

function twoDigits(n) {
  if(n < 10)
    return '0' + n;
  return n;
}

function refreshStates() {
	if(valveMap[0].state == true)
	{
		btnValveMain.addClass('toggle-button-selected');
		btnValveMain.removeClass('toggle-button-disabled');
	}
	else		
	{
		btnValveMain.addClass('toggle-button-disabled');
		btnValveMain.removeClass('toggle-button-selected');
	}

	if(valveMap[1].state == true)
	{
		btnValveTrees.addClass('toggle-button-selected');
		btnValveTrees.removeClass('toggle-button-disabled');
	}
	else		
	{
		btnValveTrees.addClass('toggle-button-disabled');
		btnValveTrees.removeClass('toggle-button-selected');
	}

	if(valveMap[2].state == true)
	{
		btnValveReserved.addClass('toggle-button-selected');
		btnValveReserved.removeClass('toggle-button-disabled');
	}
	else		
	{
		btnValveReserved.addClass('toggle-button-disabled');
		btnValveReserved.removeClass('toggle-button-selected');
	}
		
}

function refreshWeatherData() {
	var v = parseFloat(weatherData["temperature"]);	
	if(v <= 0)
		imgWeather.attr("src", "imgtemperatureblue.png");
	else if(v > 0 && v <= 10)
		imgWeather.attr("src", "imgtemperatureyellow0.png");
	else if(v > 10 && v <= 15)
		imgWeather.attr("src", "imgtemperatureyellow1.png");
	else if(v > 15 && v <= 25)
		imgWeather.attr("src", "imgtemperatureyellow2.png");
	else if(v > 25)
		imgWeather.attr("src", "imgtemperaturered.png");
	else
		imgWeather.attr("src", "imgtemperatureblue.png");

	dataWeather.html(v + " &deg;C");

	var v = parseFloat(weatherData["humidity"]);
	dataHumanity.html(v + " %");

	var v = parseFloat(weatherData["pressure"]);
	dataPressure.html(v + " hPa");
};

function handleState(valveData) {
	for(var i=0; i < valveData.valves.length; ++i)
	{
		var o = valveData.valves[i];
	
		for(var j=0; j < valveMap.length; ++j)
		{
			if(valveMap[j].name == o.name)
			{
				valveMap[j].state = o.state;
				valveMap[j].lastAccess = o.lastAccess;
			}
		}
	}
	
	refreshStates();
}

function handleData(data) {
	if(data["temperature"] !== 'undefined' && data["temperature"] !== null)
		weatherData["temperature"] = data["temperature"];
	else 
		weatherData["temperature"] = 0.0;

	if(data["humidity"] !== 'undefined' && data["humidity"] !== null)
		weatherData["humidity"] = data["humidity"];
	else
		weatherData["humidity"] = 0.0;

	if(data["pressure"] !== 'undefined' && data["pressure"] !== null)
		weatherData["pressure"] = data["pressure"];
	else
		weatherData["pressure"] = 0.0;

	refreshWeatherData();
}

$(document).ready(function() {

	initStates();

	setInterval(function() { 
		valveMap.forEach(function(entry) {
			var n = "txt" + entry.name + "Running";
			var no = $('#' + n);
			if(entry.state === true)
			{
				var di = parseInt((new Date().getTime() - entry.lastAccess) / 1000);
				var hours = parseInt(di / 3600);
				var minutes = parseInt((di - hours * 3600) / 60);
				var seconds = parseInt(di % 60);
				no.html('<b>Runs for ' + (twoDigits(hours) +":"+twoDigits(minutes)+":"+twoDigits(seconds)) + '</b>');
			}
			else
				no.html('<b>not running</b>');	
		});	
	}, 500);

	var websocket = new WebSocket(cfg.wsaddr);

	btnValveMain.click(function(){
		websocket.send(JSON.stringify({valve: "main"}));
	});
	btnValveTrees.click(function(){
		websocket.send(JSON.stringify({valve: "trees"}));
	});
	btnValveReserved.click(function(){
		websocket.send(JSON.stringify({valve: "reserved"}));
	});

	var wasConnected = false;

	websocket.onopen = function(evt) {
		wasConnected = true;
	};

	websocket.onmessage = function(str) {
		try {
			var json = JSON.parse(str.data);
			if(json.type == 'state')
				handleState(json.data);
			if(json.type == 'data')
				handleData(json.data);
			else
				; // ignore
		} catch(ex) {
			// ignore
		}
	};

	function closeHmi() {
		// todo 
	};

	function showErrorOnHmi(msg) {
		var o0 = $('#errorContainer');
		o0.show();

		var o1 = $('#errorMessage');
		o1.html(msg);
	};

	websocket.onerror = function(evt) {
		showErrorOnHmi("Can not connect to the server, hmpf ;-(<br>We will try to reconnect automatically...<br>");
		closeHmi();

		setTimeout(function() {
			location.reload();
		}, 2500);
	};

	websocket.onclose = function(evt) {
		if(wasConnected === true)
		{
			showErrorOnHmi("Connection closed: " + evt.code + " (" + evt.reason + ")<br>Just reload this page!");
			closeHmi();	
		}
	};

}); // document ready
</script>

 <style>
 
body { text-align: center; background-color: #C63D0F; color: #3B3738; }

#page-wrap { margin: 0 auto; }
.container { width: 100%; background-color: #FDF3E7; border-radius: 25px; }

h3 { height: 30px; color: #7E8F7C; }

.toggle-button { background-color: white; margin: 5px 0; border-radius: 20px; border: 2px solid #D0D0D0; height: 24px; cursor: pointer; width: 50px; position: relative; display: inline-block; user-select: none; -webkit-user-select: none; -ms-user-select: none; -moz-user-select: none; }

.toggle-button button { cursor: pointer; outline: 0; display:block; position: absolute; left: 0; top: 0; border-radius: 100%; width: 30px; height: 30px; background-color: white; float: left; margin: -3px 0 0 -3px; border: 2px solid #D0D0D0; transition: left 0.3s; }

.toggle-button-selected { background-color: #83B152; border: 2px solid #7DA652; }
.toggle-button-selected button { left: 26px; top: 0; margin: 0; border: none; width: 24px; height: 24px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }

.toggle-button-disabled { background-color: #ff0000; border: 1px solid #a24e4e; }
.toggle-button-disabled button { left: 0px; top: 0; margin: 0; border: none; width: 24px; height: 24px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }

#errorContainer { padding-top: 10px; color: red; font-weight: bold; display: none; }

#topline { width: 100%; padding-top: 15px; padding-bottom: 15px; }
#topline_temperature { padding-left: 10px; padding-right: 10px; height: 32px; line-height: 32px; display: inline-block; }
#topline img { vertical-align: middle; padding-right: 8px; }
#topline span { font-weight: bold; display: inline-block; vertical-align: middle; }
 </style>
</head>
<body>

<div id="page-wrap">

<div class="container">

  <div id="topline">
   <div id="topline_temperature">
    <img id="imgpressure" src="imgpressure.png" border="0" width="32" height="32" align="left">
    <span id="datapressure">0.0 hPa</span>
   </div>

   <div id="topline_temperature">
    <img id="imghumanity" src="imghumanity.png" border="0" width="32" height="32" align="left">
    <span id="datathumanity">0.0 %</span>
   </div>

   <div id="topline_temperature">
    <img id="imgtemperature" src="imgtemperatureyellow0.png" border="0" width="32" height="32" align="left">
    <span id="datatemperature">0.0 &deg;C</span>
   </div>
  </div>

  <div id="errorContainer">
    <img src="imgerror.png" border="0" width="32" height="32" />
	<div id="errorMessage"></div>
  </div>

  <h3>Front Garden<br>(trees)</h3> <div id="txttreesRunning"></div> <div class="toggle-button" id="btnValveTrees"><button></button></div>
  <h3>Front Garden<br>(large area)</h3> <div id="txtmainRunning"></div> <div class="toggle-button" id="btnValveMain"><button></button></div>
  <h3>reserved<br>(not used)</h3> <div id="txtreservedRunning"></div> <div class="toggle-button" id="btnValveReserved"><button></button></div>
</div>

</div> <!-- page-wrap -->
     
</body>
</html>
